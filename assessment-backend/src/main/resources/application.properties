spring.application.name=assessment-backend
env.server.host = "${SERVER_HOST:localhost}"
# server.address = "${SERVER_HOST:::}"
# Actuator configuration for health checks
management.endpoints.web.exposure.include=health
management.endpoint.health.show-details=always

# Database configuration
# Railway provides DATABASE_URL, or use individual PGHOST/PGPORT/etc variables
# Default port changed to 5432 (standard PostgreSQL port used by Railway)
spring.datasource.url=${DATABASE_URL:jdbc:postgresql://${PGHOST:localhost}:${PGPORT:5432}/${PGDATABASE:skillsoft_assessment_dev}}
spring.datasource.username=${PGUSER:postgres}
spring.datasource.password=${PGPASSWORD:password}

# JPA/Hibernate configuration
spring.jpa.hibernate.ddl-auto=validate
# Disable SQL logging in production (causes 500 logs/sec on Railway)
spring.jpa.show-sql=false
spring.jpa.properties.hibernate.format_sql=false
spring.jpa.properties.hibernate.dialect=org.hibernate.dialect.PostgreSQLDialect
spring.jpa.properties.hibernate.physical_naming_strategy=org.hibernate.boot.model.naming.PhysicalNamingStrategyStandardImpl
spring.jpa.properties.hibernate.globally_quoted_identifiers=false

# ===== CRITICAL LOGGING CONFIGURATION FOR RAILWAY DEPLOYMENT =====
# Reduce Hibernate logging to WARN level (prevents 500 logs/sec)
logging.level.org.hibernate.SQL=WARN
logging.level.org.hibernate.orm.jdbc.bind=WARN
logging.level.org.hibernate.type.descriptor.sql.BasicBinder=WARN
logging.level.org.hibernate.type=WARN
logging.level.org.hibernate.engine.jdbc.spi.SqlExceptionHelper=ERROR
logging.level.org.springframework.jdbc=WARN
logging.level.org.springframework.jdbc.core=WARN

# Reduce framework logging to absolute minimum
logging.level.org.springframework=WARN
logging.level.org.springframework.web=WARN
logging.level.org.springframework.security=WARN
logging.level.com.zaxxer.hikari=ERROR
logging.level.com.fasterxml.jackson=ERROR
logging.level.org.apache.catalina=WARN
logging.level.org.apache.coyote=WARN
logging.level.org.apache.tomcat=WARN

# Application logging - WARN for controllers (reduce request logging spam)
# INFO only for critical services
logging.level.app.skillsoft.assessmentbackend=WARN
logging.level.app.skillsoft.assessmentbackend.services.impl.TestSessionServiceImpl=INFO
logging.level.app.skillsoft.assessmentbackend.controller=WARN
logging.level.root=WARN

# Jackson JSON configuration
spring.jackson.serialization.fail-on-empty-beans=false
spring.jackson.deserialization.fail-on-unknown-properties=false
spring.jackson.default-property-inclusion=non_null

# Data initialization disabled - all DDL managed exclusively via Flyway migrations (V1-V28)
spring.sql.init.mode=never

# Server configuration
server.port=${SERVER_PORT:8080}

# Response compression (70-80% payload reduction for JSON responses)
server.compression.enabled=true
server.compression.min-response-size=1024
server.compression.mime-types=application/json,application/xml,text/html,text/xml,text/plain,text/css,text/javascript,application/javascript
server.servlet.context-path=/
spring.mvc.pathmatch.matching-strategy=ant-path-matcher

# Clerk Webhook Configuration
clerk.webhook.secret=${CLERK_WEBHOOK_SECRET:}

# HMAC shared secret for header verification between Next.js and Spring Boot
# When set, the backend verifies X-Auth-Signature on every authenticated request.
# When empty, trust-based header model is used (backward compatible for development).
app.security.hmac-secret=${HMAC_SHARED_SECRET:}

# Enhanced Exception Handler Configuration
app.exception-handler.include-stack-trace=false
app.exception-handler.include-binding-errors=true
app.exception-handler.include-exception-name=false

# Spring Boot Error Configuration
server.error.include-stacktrace=never
server.error.include-message=always
server.error.include-binding-errors=always
server.error.include-exception=false
server.error.whitelabel.enabled=false

# HikariCP connection pool settings for Railway
spring.datasource.hikari.connection-timeout=30000
spring.datasource.hikari.maximum-pool-size=8
spring.datasource.hikari.minimum-idle=2
spring.datasource.hikari.initialization-fail-timeout=60000
spring.datasource.hikari.idle-timeout=300000
spring.datasource.hikari.max-lifetime=600000
spring.datasource.hikari.register-mbeans=true
spring.datasource.hikari.keepalive-time=120000

# 404 Error Handling Configuration
spring.mvc.throw-exception-if-no-handler-found=true
spring.web.resources.add-mappings=false

# ===== RESILIENCE4J CIRCUIT BREAKER CONFIGURATION =====
# Circuit Breaker for O*NET Service
resilience4j.circuitbreaker.instances.onetService.failure-rate-threshold=50
resilience4j.circuitbreaker.instances.onetService.wait-duration-in-open-state=30s
resilience4j.circuitbreaker.instances.onetService.sliding-window-size=10
resilience4j.circuitbreaker.instances.onetService.permitted-number-of-calls-in-half-open-state=3
resilience4j.circuitbreaker.instances.onetService.sliding-window-type=COUNT_BASED
resilience4j.circuitbreaker.instances.onetService.minimum-number-of-calls=5
resilience4j.circuitbreaker.instances.onetService.automatic-transition-from-open-to-half-open-enabled=true
resilience4j.circuitbreaker.instances.onetService.register-health-indicator=true
resilience4j.circuitbreaker.instances.onetService.slow-call-duration-threshold=3s
resilience4j.circuitbreaker.instances.onetService.slow-call-rate-threshold=80

# Circuit Breaker for Team Service
resilience4j.circuitbreaker.instances.teamService.failure-rate-threshold=50
resilience4j.circuitbreaker.instances.teamService.wait-duration-in-open-state=60s
resilience4j.circuitbreaker.instances.teamService.sliding-window-size=10
resilience4j.circuitbreaker.instances.teamService.permitted-number-of-calls-in-half-open-state=3
resilience4j.circuitbreaker.instances.teamService.sliding-window-type=COUNT_BASED
resilience4j.circuitbreaker.instances.teamService.minimum-number-of-calls=5
resilience4j.circuitbreaker.instances.teamService.automatic-transition-from-open-to-half-open-enabled=true
resilience4j.circuitbreaker.instances.teamService.register-health-indicator=true
resilience4j.circuitbreaker.instances.teamService.slow-call-duration-threshold=5s
resilience4j.circuitbreaker.instances.teamService.slow-call-rate-threshold=80

# Circuit Breaker for Passport Service
resilience4j.circuitbreaker.instances.passportService.failure-rate-threshold=50
resilience4j.circuitbreaker.instances.passportService.wait-duration-in-open-state=30s
resilience4j.circuitbreaker.instances.passportService.sliding-window-size=10
resilience4j.circuitbreaker.instances.passportService.permitted-number-of-calls-in-half-open-state=3
resilience4j.circuitbreaker.instances.passportService.sliding-window-type=COUNT_BASED
resilience4j.circuitbreaker.instances.passportService.minimum-number-of-calls=5
resilience4j.circuitbreaker.instances.passportService.automatic-transition-from-open-to-half-open-enabled=true
resilience4j.circuitbreaker.instances.passportService.register-health-indicator=true
resilience4j.circuitbreaker.instances.passportService.slow-call-duration-threshold=3s
resilience4j.circuitbreaker.instances.passportService.slow-call-rate-threshold=80

# Retry Configuration for External Services
resilience4j.retry.instances.externalServices.max-attempts=3
resilience4j.retry.instances.externalServices.wait-duration=500ms
resilience4j.retry.instances.externalServices.retry-exceptions=java.io.IOException,java.net.SocketTimeoutException,java.net.ConnectException
resilience4j.retry.instances.externalServices.ignore-exceptions=java.lang.IllegalArgumentException

# ===== SCORING CALCULATION RETRY CONFIGURATION =====
# Retry transient failures (DB timeouts, network issues) during test scoring
resilience4j.retry.instances.scoringCalculation.max-attempts=3
resilience4j.retry.instances.scoringCalculation.wait-duration=500ms
resilience4j.retry.instances.scoringCalculation.exponential-backoff-multiplier=2
resilience4j.retry.instances.scoringCalculation.retry-exceptions=org.springframework.dao.DataAccessException,java.sql.SQLException,org.springframework.dao.TransientDataAccessException
resilience4j.retry.instances.scoringCalculation.ignore-exceptions=java.lang.IllegalArgumentException,app.skillsoft.assessmentbackend.exception.ResourceNotFoundException

# Circuit Breaker for Competency Loading (Repository calls)
# Per ROADMAP.md Task 3.2: Protects scoring operations from slow/unavailable database
# Opens after 50% failure rate over 5 calls, waits 10s before half-open state
resilience4j.circuitbreaker.instances.competencyLoader.failure-rate-threshold=50
resilience4j.circuitbreaker.instances.competencyLoader.wait-duration-in-open-state=10s
resilience4j.circuitbreaker.instances.competencyLoader.sliding-window-size=5
resilience4j.circuitbreaker.instances.competencyLoader.permitted-number-of-calls-in-half-open-state=2
resilience4j.circuitbreaker.instances.competencyLoader.sliding-window-type=COUNT_BASED
resilience4j.circuitbreaker.instances.competencyLoader.minimum-number-of-calls=3
resilience4j.circuitbreaker.instances.competencyLoader.automatic-transition-from-open-to-half-open-enabled=true
resilience4j.circuitbreaker.instances.competencyLoader.register-health-indicator=true

# Resilience4j Logging
logging.level.io.github.resilience4j=INFO

# ===== ACTUATOR METRICS CONFIGURATION =====
# Expose metrics endpoint for Prometheus scraping
management.endpoints.web.exposure.include=health,metrics,prometheus,caches,circuitbreakers
# Enable histogram metrics for percentile calculations
management.metrics.distribution.percentiles-histogram.test.scoring=true
management.metrics.distribution.percentiles.test.scoring=0.5,0.75,0.90,0.95,0.99
# Enable default Resilience4j metrics
management.metrics.enable.resilience4j=true
# HikariCP pool metrics
management.metrics.enable.hikaricp=true

# ===== SCORING CONFIGURATION =====
# Weight multipliers for different mapping types
# O*NET boost: Applied to competencies with O*NET SOC codes in Job Fit scoring
scoring.weights.onet-boost=1.2
# ESCO boost: Applied to competencies with ESCO URIs in Team Fit scoring
scoring.weights.esco-boost=1.15
# Big Five boost: Applied to competencies with Big Five mappings in Team Fit scoring
scoring.weights.big-five-boost=1.1
# Maximum weight multiplier cap: prevents single-competency domination from compounded boosts
scoring.weights.max-weight-multiplier=3.0

# Job Fit (Scenario B) thresholds
# Base threshold for competency pass/fail (0-1 scale)
scoring.thresholds.job-fit.base-threshold=0.5
# Maximum strictness adjustment (adds up to this % based on strictness level)
scoring.thresholds.job-fit.strictness-max-adjustment=0.3

# Team Fit (Scenario C) thresholds
# Diversity bonus threshold: min diversity ratio to qualify for bonus
scoring.thresholds.team-fit.diversity-bonus-threshold=0.4
# Saturation penalty threshold: max saturation ratio before penalty
scoring.thresholds.team-fit.saturation-penalty-threshold=0.8
# Diversity bonus multiplier (applied when good diversity/saturation balance)
scoring.thresholds.team-fit.diversity-bonus=1.1
# Saturation penalty multiplier (applied when too much overlap)
scoring.thresholds.team-fit.saturation-penalty=0.9
# Threshold for competency saturation classification
scoring.thresholds.team-fit.saturation-threshold=0.75
# Threshold for competency diversity contribution
scoring.thresholds.team-fit.diversity-threshold=0.5
# Pass threshold for overall Team Fit assessment (0-1 scale)
scoring.thresholds.team-fit.pass-threshold=0.6
# Minimum diversity ratio required to pass
scoring.thresholds.team-fit.min-diversity-ratio=0.3

# ===== SESSION CLEANUP CONFIGURATION =====
# Automatic cleanup of stale/abandoned test sessions
skillsoft.scheduling.enabled=true
skillsoft.session.cleanup.enabled=true
# Cron expression: 3 AM daily
skillsoft.session.cleanup.cron=0 0 3 * * ?
# Sessions inactive for 24h are marked as abandoned
skillsoft.session.cleanup.stale-hours=24
# Empty abandoned sessions deleted after 7 days
skillsoft.session.cleanup.delete-empty-after-days=7
# PII (name, email) removed from completed anonymous sessions after 90 days
skillsoft.session.cleanup.pii-retention-days=90

# ===== CAPTCHA CONFIGURATION =====
# hCaptcha for anonymous session creation (bot prevention)
# Disabled by default â€” enable in production with valid hCaptcha keys
skillsoft.captcha.enabled=false
skillsoft.captcha.secret-key=${HCAPTCHA_SECRET_KEY:}
skillsoft.captcha.site-key=${HCAPTCHA_SITE_KEY:}

# ===== O*NET WEB SERVICES CONFIGURATION =====
skillsoft.onet.enabled=false
skillsoft.onet.base-url=https://services.onetcenter.org/ws/
skillsoft.onet.username=${ONET_USERNAME:}
skillsoft.onet.api-key=${ONET_API_KEY:}

# ===== COMPETENCY PASSPORT CONFIGURATION =====
# Days a passport remains valid after last OVERVIEW assessment
skillsoft.passport.validity-days=180
